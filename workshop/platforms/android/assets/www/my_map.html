<!DOCTYPE HTML>

<HTML>

	<head>
		<style type="text/css">
		#panel {
        	font-family: arial;
        	padding: 0 5px;
        	height: 50%;
      	}
		</style>
		<title>Travel</title>

		<meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
		<script src="js/jquery-2.1.1.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

		<script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyAEFs7pWX6Cvviwxh9Sc4cmcMy7KcrqOxY&libraries=places"> </script>
		<script src="cordova.js"></script>
    	<script type="text/javascript" charset="utf-8" src="./js/gps.detection.js"></script>
		<script type="text/javascript">
		var map;
		var directionsRendererOptions = {
			suppressMarkers : false
		}
		var directions = new google.maps.DirectionsService();
      	var renderer = new google.maps.DirectionsRenderer(directionsRendererOptions);
      	var geocoder = new google.maps.Geocoder();
      	var geoLoc;
      	var watch_id;    // ID of the geolocation
      	var gps_on = false;
      	var numDeltas = 100;
		var delay = 10; //milliseconds
		var i = 0;
		var deltaLat;
		var deltaLng;
		var marker = undefined;
		function transition(result){
			i = 0;
			deltaLat = (result[0] - position[0])/numDeltas;
			deltaLng = (result[1] - position[1])/numDeltas;
			moveMarker();
		}
		function moveMarker(){
			position[0] += deltaLat;
			position[1] += deltaLng;
			var latlng = new google.maps.LatLng(position[0], position[1]);
			marker.setPosition(latlng);
			if(i!=numDeltas){
				i++;
				setTimeout(moveMarker, delay);
			}
		}

		$(document).ready(function() {
			var mapOptions = {
		 		center: { lat: -27.4679, lng: 153.0278},
		 		zoom: 14,
		 		mapTypeId: google.maps.MapTypeId.ROADMAP
		 	}

      		google.maps.event.addDomListener(window, 'pageshow', function() {

      			<!-- Initialize map -->
      			map = new google.maps.Map($('#map-canvas')[0], mapOptions);

      			var control = $('#transit-wpr')[0];
        		map.controls[google.maps.ControlPosition.TOP_RIGHT].push(control);

        		google.maps.event.addDomListener(control, 'click', function() {
        			var value_track = $('#transit').text().trim();

        			// Checking GPS setting
    				gpsDetect = cordova.require('cordova/plugin/gps.detection');
    				gpsDetect.checkGPSService(gpsSuccessHandler, gpsErrorHandler, [{}]);

        			if (value_track == 'Track me' && gps_on){

						// Start tracking the User
						geoLoc = navigator.geolocation;
						watch_id = geoLoc.watchPosition(

				        // Success
				        function(position){
				        	var latitude = position.coords.latitude;
	  						var longitude = position.coords.longitude;
	  						//alert("latitude: " + latitude + " longitude: " + longitude);
	  						var result = [latitude, longitude];
	  						transition(result);
				        },

				        // Error
				        function(error){
				        	console.log(error);
				        	alert('Error getting location');
				        },

				        // Settings
				        { frequency: 3000, enableHighAccuracy: true });

				        $('#transit').text('Stop tracking');
	        		}
	        		else if (value_track == 'Stop tracking'){
	        			geoLoc.clearWatch(watch_id);
	        			alert("Not tracking anymore 1");
	        			gps_on = false;
	        			$('#transit').text('Track me');
	        		}        	 		
        		});

      			route();
      			google.maps.event.trigger(map, 'resize');
			});
      		$('#my_collapsible').bind('collapsibleexpand', function () {
      			google.maps.event.trigger(map, 'resize');
      			codeAddress();
      		}).bind('collapsiblecollapse', function () {
      			
      		});
      	});
		
		function gpsSuccessHandler(on)
		{
			if (on) gps_on = true;
			else gps_on = true;
		}

		function gpsErrorHandler(e)
		{
			//alert("Error : "+e);
		}

		function codeAddress() {
			var address = localStorage.place_from;
			geocoder.geocode( { 'address': address}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					map.setCenter(results[0].geometry.location);
					map.setZoom(14);
					// track marker
					position = [results[0].geometry.location.lat(), results[0].geometry.location.lng()];
					var latlng = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
					if (marker == undefined)
					{
						marker = new google.maps.Marker({
							position: latlng,
							map: map,
							title: "Your current location!"
						});
					}
					else
					{
						marker.setPosition(latlng);
					}
				} 
				// else {
				// 	alert('Geocode was not successful for the following reason: ' + status);
				// }
			});
		}

		function route() {
			var departure = localStorage.place_time;
			var bits = departure.split(':');
			var now = new Date();
			var tzOffset = (now.getTimezoneOffset() + 60) * 60 * 1000;

			var time = new Date();
			time.setHours(bits[0]);
			time.setMinutes(bits[1]);

			var ms = time.getTime() - tzOffset;
			if (ms < now.getTime()) {
				ms += 24 * 60 * 60 * 1000;
			}

			var departureTime = new Date(ms);

			var request = {
				origin: localStorage.place_from,
				destination: localStorage.place_des,
				travelMode: google.maps.DirectionsTravelMode[localStorage.place_mode],
				provideRouteAlternatives: true,
				transitOptions: {
					departureTime: departureTime
				}
			};

			var panel = $('#my_panel')[0];
			panel.innerHTML = '';
			directions.route(request, function(response, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					renderer.setDirections(response);
					renderer.setMap(map);
					renderer.setPanel(panel);
				} else {
					renderer.setMap(null);
					renderer.setPanel(null);
				}
			});
		}
		</script>
	</head>

	<body>
		<div id="transit-wpr">
	      <button id="transit">Track me</button>
	    </div> 
		<div data-role="collapsibleset" data-theme="a" data-content-theme="a">
			<div data-role="collapsible">
				<h4>Routes details</h4>
				<div id='my_panel'></div>
			</div>
			<div data-role="collapsible" data-content-theme="false" id = "my_collapsible">
				<h4>Map</h4>
				<div id="map-canvas" style="width: 95%; height: 85%; position: absolute;"></div>			
			</div>
		</div>
	</body>

</HTML>